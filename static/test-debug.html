<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Debug Touristeer</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Teste Debug - Touristeer</h1>
    
    <div class="test-section">
        <h2>1. Teste de Localiza√ß√£o</h2>
        <button onclick="testLocation()">Testar Geolocaliza√ß√£o</button>
        <div id="location-result" class="log">Aguardando teste...</div>
    </div>
    
    <div class="test-section">
        <h2>2. Teste de Carregamento de Pontos</h2>
        <button onclick="testTouristSpots()">Carregar Pontos Tur√≠sticos</button>
        <div id="spots-result" class="log">Aguardando teste...</div>
    </div>
    
    <div class="test-section">
        <h2>3. Teste de Imagens</h2>
        <button onclick="testImages()">Testar URLs de Imagens</button>
        <div id="images-result" class="log">Aguardando teste...</div>
    </div>
    
    <div class="test-section">
        <h2>4. Teste de PDF</h2>
        <button onclick="testPDF()">Testar Gera√ß√£o de PDF</button>
        <div id="pdf-result" class="log">Aguardando teste...</div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api';
        
        async function testLocation() {
            const result = document.getElementById('location-result');
            result.innerHTML = 'Solicitando localiza√ß√£o...';
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocaliza√ß√£o n√£o suportada');
                }
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    });
                });
                
                const location = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                result.innerHTML = `‚úÖ Localiza√ß√£o obtida:<br>` +
                    `Lat: ${location.latitude}<br>` +
                    `Lng: ${location.longitude}<br>` +
                    `Precis√£o: ${location.accuracy}m`;
                
                // Salvar para outros testes
                window.userLocation = location;
                
            } catch (error) {
                result.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }
        
        async function testTouristSpots() {
            const result = document.getElementById('spots-result');
            result.innerHTML = 'Carregando pontos tur√≠sticos...';
            
            try {
                // Testar arquivo local primeiro
                console.log('Testando carregamento do arquivo local...');
                const localResponse = await fetch('/tourist_spots.json');
                const localData = await localResponse.json();
                const localSpots = localData.tourist_spots || localData;
                
                result.innerHTML = `üìÅ Arquivo local:<br>` +
                    `Total: ${localSpots.length} pontos<br>` +
                    `Primeiros 3:<br>`;
                
                localSpots.slice(0, 3).forEach((spot, index) => {
                    result.innerHTML += `${index + 1}. ${spot.nome} - ` +
                        `Imagem: ${spot.imagem_url ? '‚úÖ' : '‚ùå'}<br>`;
                });
                
                // Testar API se houver localiza√ß√£o
                if (window.userLocation) {
                    result.innerHTML += '<br>üåê Testando API com localiza√ß√£o...<br>';
                    
                    const params = new URLSearchParams({
                        lat: window.userLocation.latitude,
                        lng: window.userLocation.longitude,
                        radius: 50,
                        category: 'tourism,attraction'
                    });
                    
                    try {
                        const apiResponse = await fetch(`${API_BASE_URL}/tourist-spots?${params}`);
                        if (apiResponse.ok) {
                            const apiSpots = await apiResponse.json();
                            result.innerHTML += `‚úÖ API respondeu: ${apiSpots.length} pontos<br>`;
                        } else {
                            result.innerHTML += `‚ùå API erro: ${apiResponse.status}<br>`;
                        }
                    } catch (apiError) {
                        result.innerHTML += `‚ùå API falhou: ${apiError.message}<br>`;
                    }
                }
                
            } catch (error) {
                result.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }
        
        async function testImages() {
            const result = document.getElementById('images-result');
            result.innerHTML = 'Testando URLs de imagens...';
            
            try {
                const response = await fetch('/tourist_spots.json');
                const data = await response.json();
                const spots = data.tourist_spots || data;
                
                result.innerHTML = 'Testando carregamento de imagens:<br>';
                
                // Testar primeiras 5 imagens
                const promises = spots.slice(0, 5).map(async (spot, index) => {
                    if (spot.imagem_url) {
                        try {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            
                            const loadPromise = new Promise((resolve, reject) => {
                                img.onload = () => resolve(true);
                                img.onerror = () => reject(false);
                                setTimeout(() => reject('timeout'), 5000);
                            });
                            
                            img.src = spot.imagem_url;
                            const loaded = await loadPromise;
                            
                            return `${index + 1}. ${spot.nome}: ‚úÖ Carregou`;
                        } catch {
                            return `${index + 1}. ${spot.nome}: ‚ùå Falhou`;
                        }
                    } else {
                        return `${index + 1}. ${spot.nome}: ‚ö†Ô∏è Sem URL`;
                    }
                });
                
                const results = await Promise.all(promises);
                result.innerHTML = 'Resultado dos testes de imagem:<br>' + results.join('<br>');
                
            } catch (error) {
                result.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }
        
        async function testPDF() {
            const result = document.getElementById('pdf-result');
            result.innerHTML = 'Testando gera√ß√£o de PDF...';
            
            try {
                // Primeiro, obter lista de rotas
                const routesResponse = await fetch(`${API_BASE_URL}/routes`);
                if (!routesResponse.ok) {
                    throw new Error('N√£o foi poss√≠vel carregar rotas');
                }
                
                const routes = await routesResponse.json();
                if (routes.length === 0) {
                    result.innerHTML = '‚ö†Ô∏è Nenhuma rota encontrada para testar PDF';
                    return;
                }
                
                const testRoute = routes[0];
                result.innerHTML = `Testando PDF da rota: ${testRoute.nome}...<br>`;
                
                // Testar gera√ß√£o de PDF
                const pdfResponse = await fetch(`${API_BASE_URL}/routes/${testRoute.id}/export-pdf`);
                
                if (pdfResponse.ok) {
                    const blob = await pdfResponse.blob();
                    result.innerHTML += `‚úÖ PDF gerado com sucesso!<br>` +
                        `Tamanho: ${(blob.size / 1024).toFixed(2)} KB<br>` +
                        `Tipo: ${blob.type}`;
                } else {
                    const errorText = await pdfResponse.text();
                    result.innerHTML += `‚ùå Erro HTTP ${pdfResponse.status}:<br>${errorText}`;
                }
                
            } catch (error) {
                result.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }
        
        // Auto-executar teste de localiza√ß√£o ao carregar
        window.addEventListener('load', () => {
            console.log('P√°gina de teste carregada');
        });
    </script>
</body>
</html>
